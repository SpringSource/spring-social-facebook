package org.springframework.social.facebook.api.ads.impl;

import java.net.URI;
import java.util.List;

import org.springframework.social.facebook.api.GraphApi;
import org.springframework.social.facebook.api.ads.AccountOperations;
import org.springframework.social.facebook.api.ads.AdAccount;
import org.springframework.social.facebook.api.ads.Stats;
import org.springframework.social.facebook.api.ads.Targeting;
import org.springframework.social.facebook.api.ads.User;
import org.springframework.social.support.URIBuilder;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.client.RestTemplate;

class AccountTemplate extends AbstractAdsOperations implements
		AccountOperations {

	private RestTemplate restTemplate;

	public AccountTemplate(GraphApi graphApi, RestTemplate restTemplate,
			boolean isAuthorizedForUser) {
		super(graphApi, isAuthorizedForUser);
		this.restTemplate = restTemplate;
	}
	
	@Override
	public String[] getConnectionTypes() {
		return new String[] { "adcampaign", "adcreative", "adgroup", "adimages"};
	}

	public AdAccount getAccount(String accountId) {
		requireAuthorization();
		return graphApi.fetchObject(getAccountId(accountId), AdAccount.class);
	}

	public List<User> getAccountUsers(String accountId) {
		requireAuthorization();
		List<User> users = graphApi.fetchConnections(accountId, "users",
				User.class);
		return users;
	}

	public Stats getAccountStats(String accountId) {
		requireAuthorization();
		return graphApi.fetchObject(getPath(getAccountId(accountId), "stats"),
				Stats.class);
	}

	public <T> List<Stats> getAccountConnectionStats(String accountId,
			Class<T> connectionType) {
		requireAuthorization();
		return graphApi.fetchConnections(getAccountId(accountId),
				getConnectionType(connectionType), Stats.class);
	}

	public long getReachEstimate(String accountId, String currency,
			Targeting targetingSpec) {
		requireAuthorization();
		MultiValueMap<String, String> parameters = new LinkedMultiValueMap<String, String>();
		parameters.set("currency", currency);
		parameters.set("targeting_spec", targetingSpec.toString());
		URI uri = URIBuilder.fromUri(GraphApi.GRAPH_API_URL + accountId)
				.queryParams(parameters).build();
		return restTemplate.getForObject(uri, Long.class);
	}

}
